%!TEX root = paper.tex
%
% PyClaw
%
% Lead currently:  David Ketcheson
%

\subsection{\pyclaw} \label{sec:pyclaw}
\pyclaw is an object-orient Python package that provides a convenient way
of setting up problems and calling the algorithms of \clawpack.  It grew
from what was initially a set of data structures and file IO routines that are
used by the other \clawpack codes and by VisClaw; these were released in
an early form in later 4.x versions of \clawpack.  Those releases also
included a fully-functional implementation of the 1D classic algorithm
in pure Python; that implementation still exists in \pyclaw and is useful
for understanding the algorithm.

The current release of PyClaw includes access to the classic algorithms as well
as the high-order algorithms introduced in SharpClaw \cite{2013_sharpclaw} (i.e., WENO
reconstruction and Runge--Kutta integrators) and can be used on large
distributed-memory parallel machines.  For the latter capability, \pyclaw
relies on PETSc \cite{petsc-user-ref}.
Lower-level code (whatever gets executed
repeatedly and needs to be fast) from the earlier Fortran Classic and SharpClaw
codes is automatically wrapped at install time using \texttt{f2py}.

Recent applications of PyClaw include studies of laser light trapping by moving
refractive index perturbations \cite{sanroman_thesis}, instabilities of weakly nonlinear detonation
waves \cite{faria2015qualitative}, and effective dispersion of nonlinear waves via diffraction in
periodic materials \cite{2015_diffractons}.  Two of these are depicted in Figure
\ref{fig:pyclaw-apps}.

\begin{figure}
\hfil\includegraphics[height=1.2in]{detonation.png}
\hskip 5pt
\hfil\includegraphics[height=1.4in]{diffractons.png}
\hskip 5pt
\caption{\label{fig:pyclaw-apps}
Left: A two-dimensional detonation wave solution of the reactive Euler equations,
showing transverse shocks that arise from instabilities; see \cite{faria2015qualitative}.
Right: Dispersion of waves in a layered medium with matched impedance and periodically-varying
sound speed; see \cite{2015_diffractons}.}
\end{figure}


\subsubsection{Librarization and Extensibility}
Scientific software is easier to use, extend, and integrate with other tools
when it is designed as a library \cite{Brown:2015cj}.  \clawpack has always been
designed to be extensible, but \pyclaw takes this further in several ways.
First, it is distributed via a widely-used package management system,
\texttt{pip}. Second, the default installation process (``\texttt{pip install
clawpack}'') provides the user with a fully-compiled code and does not require
setting environment variables.  Like other \clawpack packages, \pyclaw provides
several ``hooks'' for users to plug in custom routines (for instance, to specify
boundary conditions). In \pyclaw, these routines -- including the Riemann solver
itself -- are selected at run-time, rather than at compile-time.  These routines
can be written directly in Python, or (if they are performance-critical) in a
compiled language (like Fortran or C) and wrapped with one of the many available
tools.  Problem setup (including things like initial conditions, algorithm
selection, and output specification) is also performed at run-time, which means
that researchers can bypass much of the slower code-compile-execute-post-process
cycle. It is intended that \pyclaw be easily usable within other packages
(without control of \texttt{main()}).  

\subsubsection{Python geometry}
\pyclaw includes Python classes for describing collections of structured grids
and data on them. These classes are also used by the other codes and
VisClaw, for post-processing.  A mesh in \clawpack always consists of a set of
(possibly mapped) tensor-product
grids (interval, quadrilateral, or hexahedral), also referred to as patches.
At present, \pyclaw solvers operate only on a single patch.  Multi-patch
capability is used to represent geometries from \amrclaw and \geoclaw runs, and
is planned for utilization in a future AMR-enabled version of \pyclaw.

\subsubsection{\pyclaw Solvers} 

PyClaw includes an interface to both the Classic solvers (already described above)
and those of SharpClaw \cite{ketcheson2012pyclaw}.
SharpClaw uses a traditional method-of-lines approach, in which
spatial operators are discretized first, to achieve high-order
resolution in space and time.  Spatial derivatives are discretized
using a high-order non-oscillatory reconstruction of the solution from
cell averages, which results in a system of ODEs that are subsequently
solved using Runge--Kutta or linear multistep methods. The spatial
reconstruction is performed using the weighted essentially
non-oscillatory (WENO) reconstruction algorithm which suppresses
spurious oscillations near discontinuities.  The WENO routines in
SharpClaw were generated by PyWENO \cite{pyweno}, which is a standalone package
that generates WENO routines. 

The default time stepping routines in SharpClaw are strong stability
preserving (SSP) Runge--Kutta methods of order two to four.
Some of the methods use extra stages in order to allow for more efficient
time stepping with larger CFL numbers.
Time stepping in SharpClaw has recently been augmented to include 
linear multistep methods with variable step size.  These methods use
a time step size selection that ensures the strong stability preserving
property, as described in \cite{ssp_lmm_vss}.

\subsubsection{Parallelism}
\pyclaw includes a distributed parallel backend that uses PETSc through
the Python wrapper petsc4py.  The parallel code uses the same low-level
routines without modification.  In the high-level routines, only a few
hundred lines of Python code deal explicitly with parallel communication,
in order to transfer ghost cell information between subdomains and to
find the global maximum CFL number in order to adapt the time step
size.  The code has been demonstrated to scale with better than 90\%
efficiency on tens of thousands of processors on both the Shaheen I
(BlueGene/P) and Shaheen II (Cray XC40) supercomputers at KAUST.
A hybrid MPI/OpenMP version is already available in a development branch
and will be included in future releases.
